<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Code Share</title>
    <link
      href="//cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    

    

    <!--<link rel="stylesheet" href="css/style.css" />-->
    {% load static %}
    <!--<script src="./js/index.js"></script>-->
    <link rel="stylesheet" type="text/css" href="{% static 'style.css' %}">
    
    <!-- fontawsome -->
    <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css"> -->
    <!-- jquery -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <!-- for fontaesome icons -->
    <!-- <script src="{% static 'fontawesome_free/js/all.min.js' %}"></script> -->
</head>

  <body>
    <div id="container" class="container-fluid">
      <!-- Modal starts here -->
      <!-- Button trigger modal -->
      <div class="btn_pos">
        <button
          type="button"
          class="btn btn-primary btn-position"
          data-bs-toggle="modal"
          data-bs-target="#exampleModal"
        >
          Add Code
        </button>

        <!-- Modal -->
        <form id="upload_form" method="post" action="">
        {%csrf_token%}
        <div
          class="modal fade"
          id="exampleModal"
          tabindex="-1"
          aria-labelledby="exampleModalLabel"
          aria-hidden="true"
        >
          <div
            class="
              modal-dialog
              modal-lg
              modal-dialog-centered
              modal-dialog-scrollable
            "
          >
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Form</h5>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"
                ></button>
              </div>
              <div class="modal-body">
                <div class="mb-3">
                  <label for="exampleFormControlInput1" class="form-label"
                    >Email address</label
                  >
                  <input
                    type="email"
                    class="form-control"
                    id="id_email"
                    name="email"
                    placeholder="name@example.com"
                  />
                </div>
                <div
                class="mb-3">
                  <label for="exampleFormControlTitle"
                  class="form-label"
                    >Title</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="exampleFormControlTitle"
                    name="title"
                    placeholder="stick_man"
                    required
                  />
                </div>
                <div class="mb-3">
                  <label for="exampleFormControlAuthor" class="form-label"
                    >Author</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    name="author"
                    id="exampleFormControlAuthor"
                    placeholder="shresritik"
                    required

                  />
                </div>
                <div class="mb-3">
                  <label for="exampleFormControlTags" class="form-label"
                    >Tags</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    name="tags"
                    id="exampleFormControlTags"
                    placeholder="c stick_man  graphics"
                  />
                </div>
                <div class="mb-3">
                  <label for="exampleFormControlTextarea1" class="form-label"
                    >Code</label
                  >
                  <textarea
                    class="form-control"
                    id="exampleFormControlTextarea1"
                    name="code"
                    rows="50"
                    required

                  ></textarea>
                </div>
              </div>
              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-danger"
                  data-bs-dismiss="modal"
                >
                  Close
                </button>
                <button type="submit" class="btn btn-primary" >
                  Save
                </button>
              </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- accordian starts here -->

      <div class="accordion" id="accordionExample"></div>

      <!-- accordian ends here -->
    </div>
    <!-- Required Ace Libraries -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.13/ace.js"
      integrity="sha512-OMjy8oWtPbx9rJmoprdaQdS2rRovgTetHjiBf7RL7LvRSouoMLks5aIcgqHb6vGEAduuPdBTDCoztxLR+nv45g=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
      crossorigin="anonymous"
    ></script>
    
    <!-- Custom Scripts -->
    <!--<script src="./js/index.js"></script>-->
    <script src="{% static 'script.js' %}"></script>
    <script>
     var dataa={{data|safe}};
     var branches={{branches|safe}};
     //console.log(dataa);
     okSetupEditor(dataa);
     setupEditor(dataa)

  //to save edited code
  function save(i) {
  window.editor = ace.edit(`editor${i}`);
  let getCode = editor.getValue();
  console.log(getCode);
  editor.setReadOnly(true);
  let saveCode = document.getElementById(`save${i}`);
  saveCode.style.display = "none";

  //sending to the backend
  // async function postSaveCode() {
  //   const response = await fetch("{% url 'edit_code' %}", {
  //     method: "POST",
  //     headers: {
  //       "Content-Type": "application/text",
  //       csrfmiddlewaretoken: "{{ csrf_token }}",
  //       credentials: "same-origin",
  //       mode: "same-origin",
  //     },
  //     body: JSON.stringify(getCode),
  //   });
  //   return response.json;
  // }
  // postSaveCode()
  //   .then((data) => {
  //     console.log("Success", data);
  //   })
  //   .catch((error) => {
  //     console.error("Error:", error);
  //   });
  //sending to backend
  $.ajax({
    type:'POST',
    url:"{% url 'edit_code' %}",
    data: {
      'parent_id':dataa[i-1].pk,
      'code':JSON.stringify(getCode).substring(1,JSON.stringify(getCode).length-1),
      
      csrfmiddlewaretoken: '{{ csrf_token }}',
      
    },
    success: function(response) {
      console.log('Success saving star')
      //updata_Star count
    }, error: function (response) {
      console.log('error');
      console.log(response);   
       }
    
  })
}
     
     // To add star
     function starCode(code_position) {
  
        console.log(code_position);
        var parent_code_id = dataa[code_position].pk;
        console.log('parent_code_id',parent_code_id);
  $.ajax({
    type:'POST',
    url:"{% url 'add_star' %}",
    data: {
      'unique_ip':'ip',
      'parent_id':parent_code_id,
      csrfmiddlewaretoken: '{{ csrf_token }}',
      
    },
    success: function(response) {
      //console.log('Success saving star')
      //updata_Star count
      var stars = parseInt(dataa[code_position].fields.stars) + 1;
      document.getElementById("star" + code_position).textContent="star(" + stars + ')';
    }, error: function (response) {
      console.log('error');
      console.log(response);   
       }
    
  })
      }

    let branch_count=0;
    for (branch of branches){
      distributeBranch(branch.fields, branch_count);
      //for loading branches to any code that have brance
      branch_count+=1;
     }

    </script>
  </body>
</html>